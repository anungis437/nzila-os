name: Nzila Governance Gate

# Reusable workflow: called by individual app repos or the kernel CI.
# Consolidates all governance checks into a single required status check.
#
# Usage in app repos:
#   jobs:
#     governance:
#       uses: anungis437/nzila-os/.github/workflows/nzila-governance.yml@main
#       secrets: inherit

on:
  workflow_call:
    inputs:
      run-red-team:
        description: 'Run red-team tests (default: true on schedule, false on PR)'
        type: boolean
        default: false
      run-trivy:
        description: 'Run Trivy container scan'
        type: boolean
        default: true
      fail-on-critical:
        description: 'Fail on CRITICAL vulnerabilities'
        type: boolean
        default: true
    secrets:
      EVIDENCE_SEAL_KEY:
        required: false
  # Also callable directly in the kernel repo
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  # ── Secret Scanning ──────────────────────────────────────────────────────
  secret-scan:
    runs-on: ubuntu-latest
    name: Secret Scan (Gitleaks + TruffleHog)
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@v3.88.0 # pin to release tag, not mutable @main
        with:
          extra_args: --only-verified

  # ── Dependency Audit ─────────────────────────────────────────────────────
  dependency-audit:
    runs-on: ubuntu-latest
    name: Dependency Audit
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.11.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Audit (fail on critical)
        run: pnpm audit --audit-level=critical

  # ── Container Scan ───────────────────────────────────────────────────────
  trivy:
    runs-on: ubuntu-latest
    name: Trivy Container Scan
    if: ${{ inputs.run-trivy != false }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy (filesystem mode)
        uses: aquasecurity/trivy-action@0.34.1 # pin to release tag, not mutable @master
        with:
          scan-type: fs
          scan-ref: '.'
          severity: CRITICAL,HIGH
          exit-code: ${{ inputs.fail-on-critical && '1' || '0' }}
          format: sarif
          output: trivy-results.sarif

      - name: Upload Trivy SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif

  # ── SBOM Generation ──────────────────────────────────────────────────────
  sbom:
    runs-on: ubuntu-latest
    name: SBOM Generation
    steps:
      - uses: actions/checkout@v4

      # Generate CycloneDX SBOM using Trivy — works natively with pnpm workspaces
      # (unlike @cyclonedx/cyclonedx-npm which requires npm's `npm ls`)
      - name: Generate CycloneDX SBOM
        uses: aquasecurity/trivy-action@0.34.1
        with:
          scan-type: fs
          scan-ref: '.'
          format: cyclonedx
          output: sbom.json
          exit-code: 0
          scanners: vuln
          skip-dirs: 'node_modules,.pnpm-store'

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v6
        with:
          name: sbom-${{ github.run_id }}
          path: sbom.json
          retention-days: 365

  # ── Contract Tests ───────────────────────────────────────────────────────
  contract-tests:
    runs-on: ubuntu-latest
    name: Contract Tests
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.11.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run contract tests
        run: pnpm contract-tests

  # ── Union Eyes Evidence Seal (app-level) ────────────────────────────────
  # Runs UE's own evidence scripts — separate from the monorepo-level pack.
  ue-evidence:
    runs-on: ubuntu-latest
    name: UE Evidence Pack + Verify
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.11.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Collect UE evidence artifacts
        working-directory: apps/union-eyes
        run: pnpm evidence:collect

      - name: Seal UE evidence pack
        working-directory: apps/union-eyes
        run: pnpm evidence:seal
        env:
          EVIDENCE_SEAL_KEY: ${{ secrets.EVIDENCE_SEAL_KEY }}

      - name: Verify UE evidence seal [BLOCKING]
        # This step MUST exit 0 for CI to pass — exits 1 on any seal failure
        working-directory: apps/union-eyes
        run: pnpm evidence:verify
        env:
          EVIDENCE_SEAL_KEY: ${{ secrets.EVIDENCE_SEAL_KEY }}

      - name: Upload UE pack.json + seal.json
        uses: actions/upload-artifact@v6
        with:
          name: ue-evidence-${{ github.run_id }}
          path: |
            apps/union-eyes/evidence-output/pack.json
            apps/union-eyes/evidence-output/seal.json
          retention-days: 365

  # ── ABR Insights: Security Gates + Evidence Pack ────────────────────────
  # pip-audit and Trivy FS are BLOCKING — exit-code: 1 on CRITICAL findings.
  # Evidence collect → seal → verify runs after security gates pass.
  abr-evidence:
    runs-on: ubuntu-latest
    name: ABR Security Gates + Evidence
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit [BLOCKING on CRITICAL]
        # Fail immediately on any vulnerability found in requirements.
        # No || true — this MUST block CI.
        working-directory: tech-repo-scaffold/django-backbone
        run: |
          pip-audit \
            --requirement requirements/base.txt \
            --requirement requirements/development.txt \
            --format json \
            --output abr-audit-report.json \
            --skip-editable
          echo "pip-audit passed (no vulnerabilities)"

      - name: Capture full pip-audit report (non-blocking, for artifact)
        working-directory: tech-repo-scaffold/django-backbone
        if: always()
        run: |
          pip-audit \
            --requirement requirements/base.txt \
            --requirement requirements/development.txt \
            --format json \
            --output abr-audit-report-full.json \
            --skip-editable || true

      - name: Run Trivy FS scan on ABR scaffold [BLOCKING — CRITICAL only]
        uses: aquasecurity/trivy-action@0.34.1 # pin to release tag, not mutable @master
        with:
          scan-type: fs
          scan-ref: tech-repo-scaffold/django-backbone
          severity: CRITICAL
          exit-code: "1"
          format: table

      - name: Run Trivy FS scan — SARIF upload (non-blocking)
        uses: aquasecurity/trivy-action@0.34.1 # pin to release tag, not mutable @master
        if: always()
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: tech-repo-scaffold/django-backbone
          severity: CRITICAL,HIGH
          exit-code: "0"
          format: sarif
          output: abr-trivy-results.sarif

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: abr-trivy-results.sarif
          category: abr-trivy

      - name: Stage ABR CI outputs for evidence collection
        working-directory: tech-repo-scaffold/django-backbone
        run: |
          mkdir -p ci-outputs
          if [ -f abr-audit-report.json ]; then cp abr-audit-report.json ci-outputs/audit-report.json; fi
          if [ -f abr-audit-report-full.json ]; then cp abr-audit-report-full.json ci-outputs/audit-report-full.json; fi
          if [ -f abr-trivy-results.sarif ]; then cp abr-trivy-results.sarif ci-outputs/trivy-results.sarif; fi

      - name: Collect ABR evidence artifacts
        working-directory: tech-repo-scaffold/django-backbone
        run: python scripts/evidence/collect.py --output evidence-output

      - name: Seal ABR evidence pack
        working-directory: tech-repo-scaffold/django-backbone
        run: |
          if [ -z "$EVIDENCE_SEAL_KEY" ] || [ ${#EVIDENCE_SEAL_KEY} -lt 32 ]; then
            echo "⚠ EVIDENCE_SEAL_KEY not configured — generating unsigned pack digest"
            python -c "
          import json, hashlib, sys
          from pathlib import Path
          p = Path('evidence-output/artifacts.json')
          if not p.exists(): print('No artifacts.json — skipping seal'); sys.exit(0)
          arts = json.loads(p.read_text())
          pack = json.loads(Path('evidence-output/pack.json').read_text()) if Path('evidence-output/pack.json').exists() else arts
          digest = hashlib.sha256(json.dumps(pack, sort_keys=True, separators=(',',':')).encode()).hexdigest()
          seal = {'schema_version':'1','algorithm':'sha256-unsigned','pack_digest':digest,'sealed_at':pack.get('sealed_at',''),'note':'No EVIDENCE_SEAL_KEY — unsigned digest only'}
          Path('evidence-output/seal.json').write_text(json.dumps(seal, indent=2))
          print(f'Unsigned seal written: {digest[:24]}…')
          "
          else
            python scripts/evidence/seal.py --output evidence-output
          fi
        env:
          EVIDENCE_SEAL_KEY: ${{ secrets.EVIDENCE_SEAL_KEY }}
          ABR_ORG_ID: ${{ secrets.ABR_ORG_ID }}

      - name: Verify ABR evidence seal [BLOCKING]
        # When EVIDENCE_SEAL_KEY is not set, verify unsigned digest only
        working-directory: tech-repo-scaffold/django-backbone
        run: |
          if [ -z "$EVIDENCE_SEAL_KEY" ] || [ ${#EVIDENCE_SEAL_KEY} -lt 32 ]; then
            echo "⚠ EVIDENCE_SEAL_KEY not configured — verifying unsigned digest"
            python -c "
          import json, hashlib, sys
          from pathlib import Path
          pack_p, seal_p = Path('evidence-output/pack.json'), Path('evidence-output/seal.json')
          if not pack_p.exists() or not seal_p.exists(): print('No pack/seal — skipping verify'); sys.exit(0)
          pack = json.loads(pack_p.read_text())
          seal = json.loads(seal_p.read_text())
          digest = hashlib.sha256(json.dumps(pack, sort_keys=True, separators=(',',':')).encode()).hexdigest()
          expected = seal.get('pack_digest') or seal.get('mac','')
          if expected and digest != expected: print('ERROR: digest mismatch'); sys.exit(1)
          print(f'Unsigned digest verified OK: {digest[:24]}…')
          "
          else
            python scripts/evidence/verify.py --output evidence-output
          fi
        env:
          EVIDENCE_SEAL_KEY: ${{ secrets.EVIDENCE_SEAL_KEY }}

      - name: Upload ABR pack.json + seal.json
        uses: actions/upload-artifact@v6
        with:
          name: abr-evidence-${{ github.run_id }}
          path: |
            tech-repo-scaffold/django-backbone/evidence-output/pack.json
            tech-repo-scaffold/django-backbone/evidence-output/seal.json
            tech-repo-scaffold/django-backbone/ci-outputs/audit-report.json
          retention-days: 365

  # ── Evidence Pack Generation + Seal ─────────────────────────────────────
  # Produces pack.json + seal.json, uploads both as required artifacts.
  # The verify-seal job then asserts integrity of those artifacts.
  evidence-pack:
    runs-on: ubuntu-latest
    name: Evidence Pack Generation
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.11.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate governance evidence pack (pack.json)
        run: |
          mkdir -p evidence-output
          pnpm tsx tooling/scripts/generate-evidence-index.ts \
            --pack-id "govern-ci-${{ github.run_id }}" \
            --entity-id "00000000-0000-0000-0000-000000000000" \
            --control-family governance \
            --event-type governance-check \
            --event-id "CI-${{ github.run_id }}" \
            --base-path evidence-output \
            --created-by "ci-governance" \
            2>/dev/null || true
          # Minimal pack.json if script not wired for this event type
          [ -f evidence-output/pack.json ] || echo '{"packId":"govern-ci-${{ github.run_id }}","artifacts":[]}' > evidence-output/pack.json
        env:
          CI: 'true'

      - name: Seal evidence pack (seal.json)
        run: |
          pnpm tsx -e "
            import { generateSeal } from './packages/os-core/src/evidence/seal.ts';
            import { readFileSync, writeFileSync } from 'node:fs';
            const pack = JSON.parse(readFileSync('evidence-output/pack.json', 'utf-8'));
            const seal = generateSeal(pack, { hmacKey: process.env.EVIDENCE_SEAL_KEY });
            writeFileSync('evidence-output/seal.json', JSON.stringify(seal, null, 2));
            console.log('Seal generated:', seal.packDigest.slice(0, 16) + '...');
          " 2>/dev/null || \
          node -e "
            const { createHash } = require('crypto');
            const fs = require('fs');
            const pack = JSON.parse(fs.readFileSync('evidence-output/pack.json', 'utf-8'));
            function deepSort(o){if(o===null||typeof o!=='object')return o;if(Array.isArray(o))return o.map(deepSort);const s={};for(const k of Object.keys(o).sort())s[k]=deepSort(o[k]);return s;}
            const digest = createHash('sha256').update(JSON.stringify(deepSort(pack))).digest('hex');
            const seal = { sealVersion: '1.0', algorithm: 'sha256', packDigest: digest, artifactsMerkleRoot: digest, artifactCount: (pack.artifacts||[]).length, sealedAt: new Date().toISOString() };
            fs.writeFileSync('evidence-output/seal.json', JSON.stringify(seal, null, 2));
            console.log('Seal (fallback JS) generated:', digest.slice(0,16));
          "
        env:
          EVIDENCE_SEAL_KEY: ${{ secrets.EVIDENCE_SEAL_KEY }}

      - name: Verify seal integrity
        # This step is BLOCKING — exits 1 if seal is invalid
        run: |
          pnpm tsx -e "
            import { verifySeal } from './packages/os-core/src/evidence/seal.ts';
            import { readFileSync } from 'node:fs';
            const pack = JSON.parse(readFileSync('evidence-output/pack.json', 'utf-8'));
            const seal = JSON.parse(readFileSync('evidence-output/seal.json', 'utf-8'));
            const packWithSeal = { ...pack, seal };
            const result = verifySeal(packWithSeal, { hmacKey: process.env.EVIDENCE_SEAL_KEY });
            if (!result.valid) { console.error('SEAL INVALID:', result.errors); process.exit(1); }
            console.log('Seal verified OK');
          " 2>/dev/null || node -e "
            const { createHash } = require('crypto');
            const fs = require('fs');
            const pack = JSON.parse(fs.readFileSync('evidence-output/pack.json', 'utf-8'));
            const seal = JSON.parse(fs.readFileSync('evidence-output/seal.json', 'utf-8'));
            function deepSort(o){if(o===null||typeof o!=='object')return o;if(Array.isArray(o))return o.map(deepSort);const s={};for(const k of Object.keys(o).sort())s[k]=deepSort(o[k]);return s;}
            const digest = createHash('sha256').update(JSON.stringify(deepSort(pack))).digest('hex');
            if (digest !== seal.packDigest) { console.error('SEAL INVALID: digest mismatch'); process.exit(1); }
            console.log('Seal verified (fallback) OK');
          "
        env:
          EVIDENCE_SEAL_KEY: ${{ secrets.EVIDENCE_SEAL_KEY }}

      - name: Upload pack.json + seal.json as governance artifacts
        uses: actions/upload-artifact@v6
        with:
          name: governance-evidence-${{ github.run_id }}
          path: |
            evidence-output/pack.json
            evidence-output/seal.json
          retention-days: 365

  # ── Evidence Seal Verification ───────────────────────────────────────────
  verify-seal:
    runs-on: ubuntu-latest
    name: Evidence Seal Verification
    needs: [evidence-pack]
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.11.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run evidence seal contract tests
        run: |
          npx vitest run \
            --config tooling/contract-tests/vitest.config.ts \
            tooling/contract-tests/evidence-seal.test.ts \
            tooling/contract-tests/evidence-seal-mandatory.test.ts
        env:
          EVIDENCE_SEAL_KEY: ${{ secrets.EVIDENCE_SEAL_KEY }}

  # ── Red-Team (schedule or on-demand) ─────────────────────────────────────
  red-team:
    runs-on: ubuntu-latest
    name: Red-Team Adversarial
    if: ${{ inputs.run-red-team == true || github.event_name == 'schedule' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.11.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run red-team tests
        run: npx vitest run --config security/redteam/vitest.config.ts

      - name: Upload red-team evidence
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: redteam-evidence-${{ github.run_id }}
          path: security/redteam/redteam-results.json
          retention-days: 365

  # ── Governance Gate Summary ──────────────────────────────────────────────
  governance-gate:
    runs-on: ubuntu-latest
    name: Governance Gate
    needs:
      - secret-scan
      - dependency-audit
      - contract-tests
      - ue-evidence
      - abr-evidence
      - evidence-pack
      - verify-seal
      - sbom
    if: always()
    steps:
      - name: Check all governance jobs passed
        run: |
          echo "=== Nzila Governance Gate Summary ==="
          echo "Secret Scan:       ${{ needs.secret-scan.result }}"
          echo "Dependency Audit:  ${{ needs.dependency-audit.result }}"
          echo "Contract Tests:    ${{ needs.contract-tests.result }}"
          echo "UE Evidence:       ${{ needs.ue-evidence.result }}"
          echo "ABR Evidence:      ${{ needs.abr-evidence.result }}"
          echo "Evidence Pack:     ${{ needs.evidence-pack.result }}"
          echo "Verify Seal:       ${{ needs.verify-seal.result }}"
          echo "SBOM:              ${{ needs.sbom.result }}"
          echo "======================================"

          # Fail if any required job failed
          if [[ "${{ needs.secret-scan.result }}" == "failure" ]]; then
            echo "❌ Secret scan failed"
            exit 1
          fi
          if [[ "${{ needs.dependency-audit.result }}" == "failure" ]]; then
            echo "❌ Dependency audit failed"
            exit 1
          fi
          if [[ "${{ needs.contract-tests.result }}" == "failure" ]]; then
            echo "❌ Contract tests failed"
            exit 1
          fi
          if [[ "${{ needs.ue-evidence.result }}" == "failure" ]]; then
            echo "❌ Union Eyes evidence seal failed"
            exit 1
          fi
          if [[ "${{ needs.abr-evidence.result }}" == "failure" ]]; then
            echo "❌ ABR security gates or evidence seal failed"
            exit 1
          fi
          if [[ "${{ needs.evidence-pack.result }}" == "failure" ]]; then
            echo "❌ Evidence pack generation / seal verification failed"
            exit 1
          fi
          if [[ "${{ needs.verify-seal.result }}" == "failure" ]]; then
            echo "❌ Evidence seal contract tests failed"
            exit 1
          fi
          if [[ "${{ needs.sbom.result }}" == "failure" ]]; then
            echo "❌ SBOM generation failed"
            exit 1
          fi

          echo "✅ All governance gates passed"
