# Chapter 06 — Testing & Quality

This chapter outlines the testing strategy and quality gates for
**{{PRODUCT_NAME}}**.

## Testing pyramid

| Layer       | Tool       | Scope                             |
| ----------- | ---------- | --------------------------------- |
| Unit        | Vitest     | Pure functions, utilities, hooks  |
| Integration | Vitest     | API routes, database queries      |
| E2E         | Playwright | Full user flows in a real browser |

## Running tests

```bash
# All unit + integration tests
pnpm turbo test

# E2E tests (requires dev server on {{APP_PORT}})
pnpm --filter {{PRIMARY_APP_PATH}} run test:e2e

# Single file
pnpm vitest run path/to/file.test.ts
```

## Quality gates

Every pull request must pass the following checks before merge:

- **Lint** — `pnpm turbo lint` returns zero errors.
- **Type check** — `pnpm turbo typecheck` reports no type errors.
- **Unit tests** — All Vitest suites pass with ≥ 80 % line coverage.
- **E2E tests** — Critical user journeys pass in Playwright.
- **Build** — `pnpm turbo build` succeeds without warnings treated as errors.

## Coverage

Coverage reports are generated by Vitest and uploaded as CI artifacts. Open
`coverage/index.html` locally after running:

```bash
pnpm vitest run --coverage
```

## Writing tests

- Co-locate test files next to the source (`foo.ts` → `foo.test.ts`).
- Use `describe` / `it` blocks with clear, behavior-oriented names.
- Prefer dependency injection over global mocks.
- For database tests, use a transaction wrapper that rolls back after each test.

## Flaky test policy

Flaky tests must be quarantined within 24 hours and fixed within one sprint.
Tag quarantined tests with `@flaky` so CI can skip them temporarily.
