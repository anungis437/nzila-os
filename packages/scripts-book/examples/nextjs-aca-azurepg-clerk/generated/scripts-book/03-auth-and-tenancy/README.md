<!-- AUTO-GENERATED by nzila-scripts-book-template — do not edit directly -->

# Chapter 03 — Authentication & Multi-Tenancy

This chapter documents the authentication provider configuration and the
multi-tenant isolation model used by **CourtLens**.

## Authentication provider

The application uses **clerk** for identity management.

### Key configuration

| Variable             | Description                          |
| -------------------- | ------------------------------------ |
| `AUTH_SECRET`        | Session signing secret               |
| `AUTH_PROVIDER_URL`  | clerk issuer / tenant URL |
| `AUTH_CLIENT_ID`     | OAuth 2.0 client identifier          |
| `AUTH_CLIENT_SECRET` | OAuth 2.0 client secret              |

### Session flow

1. User visits a protected route.
2. Middleware checks for a valid session cookie.
3. If absent, the user is redirected to clerk for login.
4. On callback, a session is created and the `orgId` claim is extracted from the token.

## Multi-tenancy

Tenant isolation is enforced at the data layer using the **orgId**
column present on every tenant-scoped table.

### Isolation rules

- Every database query includes a `WHERE orgId = ?` clause.
- Row-Level Security (RLS) policies mirror this constraint at the database level.
- API middleware injects the authenticated `orgId` into the request context so that downstream handlers never need to resolve it manually.

### Adding a new tenant

1. Provision a record in the `tenants` table.
2. Create an clerk organization or group for the tenant.
3. Map the organization identifier to the `orgId` value.

## Security considerations

- Never trust a client-supplied tenant identifier; always derive it from the authenticated session.
- Rotate `AUTH_SECRET` on a regular cadence and after any suspected compromise.
- Audit log every tenant-switching event for compliance.
