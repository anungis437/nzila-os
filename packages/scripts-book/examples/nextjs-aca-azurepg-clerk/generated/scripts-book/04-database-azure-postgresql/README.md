<!-- AUTO-GENERATED by nzila-scripts-book-template — do not edit directly -->

# Chapter 04 — Database (azure_postgresql)

This chapter covers database provisioning, migration strategy, and connection
pooling for **CourtLens**.

## Provider

The production database is hosted on **azure_postgresql**. Local development
may use a Docker-based PostgreSQL instance or connect to a dev-tier remote
database.

## Connection strings

| Environment | Variable       | Example                                          |
| ----------- | -------------- | ------------------------------------------------ |
| Local       | `DATABASE_URL` | `postgresql://user:pass@localhost:5432/courtlens-platform` |
| Staging     | `DATABASE_URL` | Set via azure_container_apps secrets              |
| Production  | `DATABASE_URL` | Set via azure_container_apps secrets              |

## Migration strategy

Migrations are managed with Drizzle ORM. The workflow is:

1. Edit the schema in `apps/web/db/schema.ts`.
2. Generate a migration:

   ```bash
   pnpm --filter apps/web run db:generate
   ```

3. Apply the migration:

   ```bash
   ./04-database-azure-postgresql/migrate.sh
   ```

4. Commit both the schema change and the generated SQL file.

## Connection pooling

azure_postgresql supports built-in PgBouncer-compatible pooling. Enable it by
appending `?pgbouncer=true&connection_limit=10` to `DATABASE_URL`.

## Backup and restore

- Automated backups are configured in azure_postgresql with a 7-day retention.
- Point-in-time restore is available for production databases.

## Scripts in this chapter

| Script       | Purpose                                    |
| ------------ | ------------------------------------------ |
| `migrate.sh`  | Run pending migrations (Unix)             |
| `migrate.ps1` | Run pending migrations (Windows)          |
| `migrate.py`  | Run pending migrations (Python/cross-platform) |
