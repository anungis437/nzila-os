# CRITICAL ISSUE: Missing Organizations Model

**Date**: 2026-02-17  
**Status**: BLOCKING MIGRATIONS  
**Severity**: CRITICAL  
**Platforms Affected**: Both Union Eyes and ABR Insights

## Problem Summary

The `Organizations` model is completely missing from both platforms' Django backends despite being referenced by hundreds of ForeignKey fields across all apps. This is preventing Django migrations and system check validation.

## Root Cause Analysis

### 1. Schema Extraction Gap
- The `organizations` table does not exist in the source schema files:
  - **Union Eyes**: Not found in `D:\APPS\Union_Eyes_app_v1-main\Union_Eyes_app_v1-main\db\schema\*.ts`
  - **ABR Insights**: Not found in `D:\APPS\abr-insights-app-main\abr-insights-app-main\supabase\migrations\*.sql`
- Code generator only creates models from tables it parses from source schemas
- Table mapping specifies: `"organizations": "auth_core"` but table doesn't exist to parse

### 2. Model Registry Impact
- `build_model_registry()` builds map of `model_name → app_name` from `all_tables`
- Since Organizations table wasn't parsed, it's not in `all_tables`
- Therefore not in model registry
- FK generation code can't app-qualify the reference
- Django treats unqualified `'Organizations'` as app-local (e.g., `'ai_core.organizations'`)

### 3. Error Manifestation

**Django Check Results** (Union Eyes):
- **982 total errors** (up from 642 pre-fix)
- **70 × fields.E300**: Field defines relation with model 'Organizations', which is either not installed, or is abstract
- **70 × fields.E307**: Field declared with lazy reference to 'app.organizations', but app doesn't provide model 'organizations'
- **170 × fields.E304**: Reverse accessor clashes (related_name issues)
- **170 × fields.E305**: Reverse query name clashes (related_name issues)

**Example Error**:
```
ai_core.AbTests.organization: (fields.E307) The field ai_core.AbTests.organization was 
declared with a lazy reference to 'ai_core.organizations', but app 'ai_core' doesn't 
provide model 'organizations'.
```

## Current State

### ✅ Completed Work
1. **Code Generator Improvements**:
   - Added `build_model_registry()` method to CodeGenerator
   - Updated `ColumnDef.to_django_field_str()` to accept model_registry and current_app
   - Modified FK generation to use app-qualified references for cross-app relations
   - Updated `TableDef.to_django_model_str()` to pass registry
   - Updated `generate_app()` to build and use model registry

2. **Regeneration & Deployment**:
   - Regenerated all models for both platforms
   - Union Eyes: 512 models across 11 apps
   - ABR Insights: 116 models across 8 apps
   - Deployed to production repos

3. **Verified Cross-App FK Fixes**:
   - App-qualified references work correctly when model exists in registry
   - Example: `'auth_core.OrganizationMembers'` (correct app qualification)

### ❌ Blocking Issues
1. **Organizations Model Missing**:
   - Not in source schemas
   - Not generated by code generator
   - Referenced by ~35 models across all apps
   - Each reference generates 2 Django errors (E300 + E307)

2. **Related Name Clashes** (170 × 2 = 340 errors):
   - Field-name-based related_names not unique enough
   - Example: Multiple models have `session` FK to `VotingSessions`
   - All generate `related_name='sessions'` → clash

## Path Forward

### Immediate Actions Required

#### 1. Create Organizations Model (CRITICAL)
**Options**:

**Option A: Manual Model Creation** (Fastest - 30 min)
```python
# auth_core/models.py
class Organizations(BaseModel):
    """Core organization/tenant model."""
    name = models.CharField(max_length=255)
    slug = models.SlugField(unique=True)
    # ... add required fields based on legacy codebase inspection
```

**Option B: Extract from Supabase/Database** (Recommended - 2-3 hours)
1. Connect to legacy Supabase instances
2. Dump `organizations` table schema
3. Generate SQL migration or Drizzle schema
4. Re-run code generator
5. Verify Organizations model generated in auth_core

**Option C: Reverse Engineer from FKs** (Fallback - 1-2 hours)
1. Analyze all ForeignKey(organization_id) references
2. Infer required fields
3. Create minimal viable Organizations model
4. Iterate based on legacy codebase

#### 2. Fix Related Name Clashes (140 errors)
**Solution**: Update FK generation to use model+field pattern
```python
# Current (causes clashes):
related_name = field_name.replace("_id", "").replace("_", "") + "s"
# → session FK generates: related_name='sessions'

# Fixed (unique):
related_name = f"{model_name_snake}_{field_name_snake}_set"
# → VotingAuditLog.session generates: related_name='votingauditlog_session_set'
```

#### 3. Verify OrganizationModel Base Class
Current abstract base references:
```python
organization = models.ForeignKey(
    'organizations.Organization',  # Wrong - should be 'auth_core.Organizations'
    on_delete=models.CASCADE,
    related_name='%(class)ss'
)
```

### Implementation Plan

**Phase 1: Organizations Model** (BLOCKING)
- [ ] Inspect legacy Supabase for organizations table schema
- [ ] Create Organizations model in auth_core
- [ ] Add to model registry manually if needed
- [ ] Regenerate OrganizationModel abstract base
- [ ] Deploy and test

**Phase 2: Related Name Fix** (HIGH PRIORITY)
- [ ] Update `ColumnDef.to_django_field_str()` with unique related_name pattern
- [ ] Regenerate all models
- [ ] Deploy and validate

**Phase 3: Final Validation** (REQUIRED)
- [ ] Django check: 0 errors expected
- [ ] Makemigrations: Should detect new models
- [ ] Migrate: Create database schema
- [ ] Test basic CRUD operations

## Testing Checklist

After Organizations model is created:
```bash
# Union Eyes
cd C:\APPS\nzila-union-eyes\backend
python manage.py check  # Expect: errors drop from 982 → ~340 (related_name only)
python manage.py makemigrations  # Should work after related_name fix
python manage.py migrate --run-syncdb  # Create tables

# ABR Insights
cd D:\APPS\nzila-abr-insights\backend
python manage.py check
python manage.py makemigrations
python manage.py migrate --run-syncdb
```

## Progress Tracking Impact

This issue blocks:
- ✅ `code_generation` phase (100% complete)
- ❌ `model_migration` phase (0% - blocked)
- ❌ `data_migration` phase (0% - blocked)
- ❌ `api_generation` phase (depends on migrations)

**Current Progress**: Both platforms stuck at 38.5%

**Next Milestone After Fix**: 46.2% (model_migration + api_scaffold)

## Related Files

**Code Generator**:
- `packages/automation/generators/code_generator.py` (1971 lines)
  - Lines 1180-1186: `build_model_registry()`
  - Lines 58-91: `ColumnDef.to_django_field_str()`
  - Lines 1200-1207: `generate_app()`

**Model Mappings**:
- Lines 1318, 1378: `"organizations": "auth_core"`

**Generated Models** (need Organizations):
- `C:\APPS\nzila-union-eyes\backend\**\models.py` (11 apps)
- `D:\APPS\nzila-abr-insights\backend\**\models.py` (8 apps)

**Reports**:
- `packages/automation/data/MIGRATION_DASHBOARD.md`
- `packages/automation/data/ue_progress.json`
- `packages/automation/data/abr_progress.json`

## Notes

- Organizations model was likely created directly in Supabase UI or via manual migration
- Not captured in version-controlled schema files
- Common pattern in multi-tenant SaaS apps bootstrapped with Supabase
- Similar issue may exist for other "system" tables (roles, permissions, etc.)

## Decision Needed

**Which approach for Organizations model creation?**
- [ ] Option A: Manual (fastest, may be incomplete)
- [ ] Option B: Database extraction (most accurate, requires DB access)
- [ ] Option C: Reverse engineering (middle ground)

**Recommendation**: Option B if Supabase access available, else Option C with Option A as fallback.
